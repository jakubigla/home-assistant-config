---
binary_sensor:
  - name: ensuite_bathroom_is_dark
    device_class: light
    delay_on: "00:00:05"
    delay_off: "00:00:30"
    state: >
      {% set illuminance = states('sensor.ensuite_bathroom_illuminance') | float %}
      {% set outdoor_dark = is_state('binary_sensor.outdoor_is_dark', 'on') %}
      {% set currently_dark = is_state('binary_sensor.ensuite_bathroom_is_dark', 'on') %}

      {% if outdoor_dark %}
        on
      {% elif currently_dark %}
        {{ illuminance < 15 }}
      {% else %}
        {{ illuminance < 10 }}
      {% endif %}
    attributes:
      illuminance: "{{ states('sensor.ensuite_bathroom_illuminance') }}"
      outdoor_dark: "{{ is_state('binary_sensor.outdoor_is_dark', 'on') }}"
      threshold_used: >
        {% if is_state('binary_sensor.outdoor_is_dark', 'on') %}
          outdoor_dark
        {% elif is_state('binary_sensor.ensuite_bathroom_is_dark', 'on') %}
          15 (hysteresis_off)
        {% else %}
          10 (hysteresis_on)
        {% endif %}
